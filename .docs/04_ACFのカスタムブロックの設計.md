# ACFã®ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®è¨­è¨ˆ

é–¢é€£è¨˜äº‹: [ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®ä½œã‚Šæ–¹](09_ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®ä½œã‚Šæ–¹.md)

---

## ç›®æ¬¡

- [ä»•çµ„ã¿](#ä»•çµ„ã¿)
  - [1. scaffdogã‚’åˆ©ç”¨ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ](#1-scaffdogã‚’åˆ©ç”¨ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ)
  - [2.ãƒ–ãƒ­ãƒƒã‚¯ã®ç™»éŒ²å‡¦ç†](#2ãƒ–ãƒ­ãƒƒã‚¯ã®ç™»éŒ²å‡¦ç†)
  - [3.ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°](#3ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°)
  - [4.ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®ç™»éŒ²](#4ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®ç™»éŒ²)
- [ğŸ“ƒ è£œéº](#-è£œéº)

---

> å½“é–‹ç™ºç’°å¢ƒã§ã¯ã€**ã‚³ãƒãƒ³ãƒ‰ä¸€ã¤ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç”Ÿæˆã§ãã‚‹æ©Ÿèƒ½**ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚
> ã“ã®æ©Ÿèƒ½ã«ã¯ACFPROã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
> 
> å‚ç…§ï¼š
> https://www.advancedcustomfields.com/resources/create-your-first-acf-block/

## ä»•çµ„ã¿

ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¦ã‹ã‚‰ãƒ–ãƒ­ãƒƒã‚¯ãŒä½œæˆã•ã‚Œã‚‹ã¾ã§ã®ãƒ•ãƒ­ãƒ¼ã§ã™ã€‚

### 1. scaffdogã‚’åˆ©ç”¨ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ

https://scaff.dog/

```shell
npx scaffdog generate acf-block
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å¯¾è©±å½¢å¼ã§ã®ãƒ–ãƒ­ãƒƒã‚¯ã®ç™»éŒ²ãŒå§‹ã‚Šã¾ã™ã€‚å…¨ã¦è¨­å®šã—çµ‚ãˆã‚‹ã¨ã€`.scaffdog/acf-block.md` ã§è¨­å®šã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

3ã¤ã®é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã€çµæœçš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã«ãªã‚Šã¾ã™ã€‚

```
mytheme/
â”œâ”€â”€ acf-json/
â”‚   â””â”€â”€ group_custom_[ãƒ–ãƒ­ãƒƒã‚¯å].json â† ACFã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©
â”œâ”€â”€ blocks/
â”‚   â””â”€â”€ [ãƒ–ãƒ­ãƒƒã‚¯å]/
â”‚       â””â”€â”€ block.jsonã€€â† ãƒ–ãƒ­ãƒƒã‚¯ã®å®šç¾©
â””â”€â”€ view/
    â””â”€â”€ blocks/
        â””â”€â”€ [ãƒ–ãƒ­ãƒƒã‚¯å].twigã€€â† ãƒ“ãƒ¥ãƒ¼ç”¨ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```

### 2.ãƒ–ãƒ­ãƒƒã‚¯ã®ç™»éŒ²å‡¦ç†

`mytheme/inc/blocks.php` ã®`register_block_type()` ã«ã¦ã€`mytheme/blocks/[ãƒ–ãƒ­ãƒƒã‚¯å]/block.json` ã§å®šç¾©ã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’ACFã«ç™»éŒ²ã—ã¾ã™ã€‚

```php
/**
 * ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
 */
add_action(
	"init",
	function () {
		foreach (glob(dirname(__DIR__) . "/blocks/*", GLOB_ONLYDIR) as $dir) {
			register_block_type($dir);
		}
	},
	5
);
```

ç®¡ç†ç”»é¢ã‹ã‚‰ACFã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ã€ŒåŒæœŸã€ã®ã¨ã“ã‚ã«ä½œã£ãŸãƒ–ãƒ­ãƒƒã‚¯ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

ãŸã ã—ã“ã‚Œã ã‘ã§ã¯ã€ç·¨é›†ç”»é¢ã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’é…ç½®ã—ã¦ã‚‚ãƒ“ãƒ¥ãƒ¼ãŒæ¸¡ã•ã‚Œã¦ãªã„ã®ã§ã€ã‚µã‚¤ãƒˆã«ã¯ä½•ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚

### 3.ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

`block.json` ã§ã¯ã€`renderCallback`ã«ã¦`my_acf_block_render_callback()`ã‚’ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã¨ã—ã¦æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

```json
{
	"name": "acf/[ãƒ–ãƒ­ãƒƒã‚¯å]",
	
	--- çœç•¥ ---
	
	"attributes": {},
	"acf": {
		"mode": "edit",
		"renderCallback": "my_acf_block_render_callback"
	},
	"example": {
		"attributes": {
			"mode": "preview",
			"data": {
				"__is_preview": true
			}
		}
	}
}
```

`my_acf_block_render_callback()` ã¯`mytheme/inc/acf-blocks.php`ã«å®šç¾©ã—ã¦ã‚ã‚Šã¾ã™ã€‚

ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã®è©³ç´°ã¯ã‚³ãƒ¡ãƒ³ãƒˆã®é€šã‚Šã§ã™ã€‚

ã“ã®é–¢æ•°ã«ã‚ˆã£ã¦ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«(Twig)ãŒãƒ–ãƒ­ãƒƒã‚¯ã«æ¸¡ã•ã‚Œã€ã‚µã‚¤ãƒˆä¸Šã§è¦‹ãŸç›®ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```php
<?php

use Timber\Timber;

/**
 * ACFãƒ–ãƒ­ãƒƒã‚¯ã®è¡¨ç¤ºç”¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
 * - ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®è¨­å®š
 * - ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆtwigï¼‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
 *
 * @param array  $block      ãƒ–ãƒ­ãƒƒã‚¯ã®è¨­å®šã¨å±æ€§æƒ…å ±ã€‚
 * @param string $block_slug    ãƒ–ãƒ­ãƒƒã‚¯ã®åå‰ï¼ˆacf/ã‚’é™¤ãï¼‰ã€‚
 * @param string $content    ãƒ–ãƒ­ãƒƒã‚¯ã®å†…å®¹ï¼ˆé€šå¸¸ã¯ç©ºæ–‡å­—ï¼‰ã€‚
 * @param bool   $is_preview ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ä¸Šã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚ã¯ trueã€‚
 */
function my_acf_block_render_callback($block, $content, $is_preview)
{
	$block_slug = str_replace("acf/", "", $block["name"]);

	$context = Timber::context();
	foreach (
		[
			"block" => $block,
			"block_slug" => $block_slug,
			"fields" => get_fields(),
			"is_preview" => $is_preview,
		]
		as $key => $value
	) {
		$context[$key] = $value;
	}

	/**
	 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®è¨­å®š
	 */
ã€€--- çœç•¥ ---

	Timber::render("blocks/" . $block_slug . ".twig", $context);
}
```

### 4.ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®ç™»éŒ²

ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã¯ã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒ–ãƒ­ãƒƒã‚¯é¸æŠæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒã§ã™ã€‚

![ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®ä¾‹](https://deep-space.blue/main/wp-content/uploads/2023/08/image-28.png)

ã“ã‚Œã‚’ãƒ–ãƒ­ãƒƒã‚¯æ¯ã«ç™»éŒ²ã™ã‚‹å‡¦ç†ã‚’ã€`acf-blocks.php` ã«å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```php
	/**
	 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®è¨­å®š
	 */
	if (!empty($block["data"]["__is_preview"])) {
		$assets_dir = get_template_directory() . "/assets/blocks-preview/";
		$assets_url = get_template_directory_uri() . "/assets/blocks-preview/";
		$preview_image_name = $block_slug . ".png";

		$preview_image_path = $assets_dir . $preview_image_name;
		$preview_image_url = $assets_url . $preview_image_name;

		if (file_exists($preview_image_path)) {
			echo "<img src='" .
				esc_url($preview_image_url) .
				"' alt='{$block_slug} preview' style='width:100%; height:auto;' />";
			return;
		}
	}
```

`mytheme/assets/blocks-preview/[ãƒ–ãƒ­ãƒƒã‚¯å].png` ã‚’ç½®ã„ã¦ãŠã‘ã°ã€ãã‚ŒãŒãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™ã€‚

ã¾ãŸã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®è¡¨ç¤ºã«ã¯ã€block.jsonã§ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã“ã¨ãŒå¿…é ˆã§ã™ã€‚

```php
	"example": {
		"attributes": {
			"mode": "preview",
			"data": {
				"__is_preview": true
			}
		}
	}
```

## ğŸ“ƒ è£œéº

> æ¡ˆä»¶ã§ã€è©³ç´°ãƒšãƒ¼ã‚¸ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹è¦ä»¶ã¯å¤šã„ã§ã™ã€‚
> 
> ACFã®GUIæ“ä½œã§ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œã£ã¦ã‚‚ã‚‚ã¡ã‚ã‚“ã„ã„ã®ã§ã™ãŒã€
> Twigãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚„ `block.json` ã®æ§‹é€ å®šç¾©ã‚’ã‚³ãƒ¼ãƒ‰ç®¡ç†ã™ã‚‹ã“ã¨ã§ã€
> Gitã§ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®¹æ˜“ã«ãªã‚Šã€**ä¿å®ˆãƒ»ãƒ‡ãƒãƒƒã‚°æ€§ãŒå‘ä¸Š**ã™ã‚‹ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚
> 
> **å¹¸ã„ã€Gutenberg ã«å¯¾å¿œã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**ãŒå…¬å¼ã«ã‚ã£ãŸã®ã§ã€ã“ã‚Œã«æº–ãˆãŸæ©Ÿèƒ½ã‚’ä½œã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
> 
> https://www.advancedcustomfields.com/resources/create-your-first-acf-block/
